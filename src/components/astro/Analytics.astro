---
import { getSiteConfig } from '../../lib/config';

const config = getSiteConfig();
const analytics = config.analytics;
const consent = config.cookieConsent;

const ga = analytics?.googleAnalytics || '';
const gtm = analytics?.googleTagManager || '';
const cronitor = analytics?.cronitor || '';
const openpanel = analytics?.openpanel || '';
const pirsch = analytics?.pirsch || '';
const clarity = analytics?.microsoftClarity || '';

// When cookie consent is enabled, scripts are blocked until user accepts
const consentAttrs = consent ? { type: 'text/plain', 'data-category': 'analytics' } : {};
---

{/* Google Analytics */}
{ga && (
  <Fragment>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga}`} {...consentAttrs}></script>
    <script {...consentAttrs} is:inline define:vars={{ ga }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} // eslint-disable-line prefer-rest-params
      gtag('js', new Date());
      gtag('config', ga);
    </script>
  </Fragment>
)}

{/* Google Tag Manager */}
{gtm && (
  <script {...consentAttrs} is:inline define:vars={{ gtm }}>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});const f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer',gtm);
  </script>
)}

{/* Cronitor RUM */}
{cronitor && (
  <Fragment>
    <script async src="https://rum.cronitor.io/script.js" {...consentAttrs}></script>
    <script {...consentAttrs} is:inline define:vars={{ cronitor }}>
      window.cronitor = window.cronitor || function() { (window.cronitor.q = window.cronitor.q || []).push(arguments); }; // eslint-disable-line prefer-rest-params
      cronitor('config', { clientKey: cronitor });
    </script>
  </Fragment>
)}

{/* OpenPanel */}
{openpanel && (
  <Fragment>
    <script src="https://openpanel.dev/op1.js" defer async {...consentAttrs}></script>
    <script {...consentAttrs} is:inline define:vars={{ openpanel }}>
      window.op = window.op || function (...args) { (window.op.q = window.op.q || []).push(args); };
      window.op('init', { clientId: openpanel, trackScreenViews: true, trackOutgoingLinks: true, trackAttributes: true });
    </script>
  </Fragment>
)}

{/* Pirsch */}
{pirsch && (
  <script defer src="https://api.pirsch.io/pa.js"
    id="pianern"
    data-code={pirsch}
    {...consentAttrs}
  ></script>
)}

{/* Microsoft Clarity */}
{clarity && (
  <script {...consentAttrs} is:inline define:vars={{ clarity }}>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; // eslint-disable-line prefer-rest-params
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window,document,"clarity","script",clarity);
  </script>
)}
