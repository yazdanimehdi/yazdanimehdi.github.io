---
import { getSiteConfig } from '../../lib/config';

const config = getSiteConfig();
const currentPath = Astro.url.pathname;

function isActive(href: string): boolean {
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}
---

<div class="relative flex items-center gap-0.5" data-nav-overflow>
  <nav class="flex items-center gap-0.5" data-nav-visible>
    {
      config.nav.map((item) => (
        <a
          href={item.href}
          class:list={[
            'px-2.5 py-1.5 text-sm whitespace-nowrap transition-colors',
            isActive(item.href)
              ? 'font-medium text-primary-600 dark:text-accent-400'
              : 'text-surface-600 hover:text-primary-600 dark:text-dm-muted dark:hover:text-accent-400',
          ]}
          aria-current={isActive(item.href) ? 'page' : undefined}
          data-nav-item
        >
          {item.label}
        </a>
      ))
    }
  </nav>

  <!-- "More" dropdown toggle -->
  <div class="relative hidden" data-nav-more>
    <button
      type="button"
      class="flex items-center gap-1 px-2.5 py-1.5 text-sm whitespace-nowrap text-surface-600 transition-colors hover:text-primary-600 dark:text-dm-muted dark:hover:text-accent-400"
      data-nav-more-btn
      aria-expanded="false"
      aria-haspopup="true"
    >
      More
      <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>
    <div
      class="absolute end-0 top-full z-50 mt-1 hidden min-w-[160px] rounded-md border border-surface-200 bg-white py-1 shadow-lg dark:border-dm-border-alt dark:bg-dm-alt"
      data-nav-more-menu
    >
      <!-- Overflow items inserted here by JS -->
    </div>
  </div>
</div>

<script>
  function initNavOverflow() {
    const containers = document.querySelectorAll<HTMLElement>('[data-nav-overflow]');
    containers.forEach(setupOverflow);
  }

  function setupOverflow(container: HTMLElement) {
    // Guard against duplicate setup
    if (container.hasAttribute('data-nav-initialized')) return;
    container.setAttribute('data-nav-initialized', '');

    const nav = container.querySelector<HTMLElement>('[data-nav-visible]');
    const moreWrapper = container.querySelector<HTMLElement>('[data-nav-more]');
    const moreBtn = container.querySelector<HTMLButtonElement>('[data-nav-more-btn]');
    const moreMenu = container.querySelector<HTMLElement>('[data-nav-more-menu]');
    if (!nav || !moreWrapper || !moreBtn || !moreMenu) return;

    const items = Array.from(nav.querySelectorAll<HTMLAnchorElement>('[data-nav-item]'));
    if (items.length === 0) return;

    function measure() {
      // Reset: show all items, hide More
      items.forEach((item) => item.classList.remove('hidden'));
      moreWrapper.classList.add('hidden');
      while (moreMenu.firstChild) moreMenu.removeChild(moreMenu.firstChild);
      moreMenu.classList.add('hidden');
      moreBtn.setAttribute('aria-expanded', 'false');

      // Walk up to find the header row (flex justify-between container)
      const headerRow = container.closest('.flex.justify-between') as HTMLElement | null;
      if (!headerRow) return;

      // Find the logo and theme toggle to calculate their widths
      const logo = headerRow.querySelector<HTMLElement>('[data-nav-logo]');
      const themeToggle = container.parentElement?.querySelector('.border-s') as HTMLElement | null;
      const logoWidth = logo ? logo.getBoundingClientRect().width : 0;
      const toggleWidth = themeToggle ? themeToggle.getBoundingClientRect().width + 8 : 40;
      // Reserve space for the "More" button (~70px) + gaps (~24px)
      const totalReserved = logoWidth + toggleWidth + 70 + 24;
      const availableWidth = headerRow.clientWidth - totalReserved;
      const navLeft = nav.getBoundingClientRect().left;

      let overflowStartIndex = items.length;
      for (let i = 0; i < items.length; i++) {
        const rect = items[i].getBoundingClientRect();
        if (rect.right - navLeft > availableWidth) {
          overflowStartIndex = i;
          break;
        }
      }

      if (overflowStartIndex < items.length) {
        // Hide overflow items and create dropdown links
        for (let i = overflowStartIndex; i < items.length; i++) {
          items[i].classList.add('hidden');

          const link = document.createElement('a');
          link.href = items[i].href;
          link.textContent = items[i].textContent?.trim() || '';
          if (items[i].getAttribute('aria-current') === 'page') {
            link.className =
              'block px-3 py-1.5 text-sm font-medium text-primary-600 dark:text-accent-400 bg-surface-50 dark:bg-dm-hover';
            link.setAttribute('aria-current', 'page');
          } else {
            link.className =
              'block px-3 py-1.5 text-sm text-surface-600 hover:text-primary-600 hover:bg-surface-50 dark:text-dm-muted dark:hover:text-accent-400 dark:hover:bg-[#1c2128] transition-colors';
          }
          moreMenu.appendChild(link);
        }
        moreWrapper.classList.remove('hidden');
      }
    }

    // Toggle dropdown
    moreBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = moreBtn.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        moreMenu.classList.add('hidden');
        moreBtn.setAttribute('aria-expanded', 'false');
      } else {
        moreMenu.classList.remove('hidden');
        moreBtn.setAttribute('aria-expanded', 'true');
      }
    });

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target as Node)) {
        moreMenu.classList.add('hidden');
        moreBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Measure on load and resize
    measure();
    const resizeHandler = () => measure();
    window.addEventListener('resize', resizeHandler);
  }

  // Run on initial load and after Astro view transitions
  initNavOverflow();
  document.addEventListener('astro:after-swap', () => {
    // Remove init guard so new DOM elements get set up
    document.querySelectorAll('[data-nav-initialized]').forEach((el) => {
      el.removeAttribute('data-nav-initialized');
    });
    initNavOverflow();
  });
</script>
