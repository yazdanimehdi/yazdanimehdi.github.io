---
// GDPR cookie consent banner — only rendered when cookieConsent is true in config.
// Stores preference in localStorage as "cookie-consent" = "accepted" | "declined".
// When accepted, scripts with data-category="analytics" are activated.
---

<div id="cookie-consent-banner" class="fixed inset-x-0 bottom-0 z-50 hidden" role="dialog" aria-label="Cookie consent">
  <div class="mx-auto max-w-4xl p-4">
    <div
      class="rounded-lg border border-gray-200 bg-white p-4 shadow-lg sm:flex sm:items-center sm:justify-between sm:gap-4 dark:border-gray-700 dark:bg-gray-900"
    >
      <p class="text-sm text-gray-700 dark:text-gray-300">
        This site uses cookies for analytics. You can accept or decline.
      </p>
      <div class="mt-3 flex gap-2 sm:mt-0 sm:shrink-0">
        <button
          id="cookie-decline"
          type="button"
          class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          Decline
        </button>
        <button
          id="cookie-accept"
          type="button"
          class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-400"
        >
          Accept
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const STORAGE_KEY = 'cookie-consent';
    const banner = document.getElementById('cookie-consent-banner');
    if (!banner) return;

    const stored = localStorage.getItem(STORAGE_KEY);

    if (stored === 'accepted') {
      activateAnalytics();
      return;
    }
    if (stored === 'declined') {
      return;
    }

    // No decision yet — show the banner
    banner.classList.remove('hidden');

    document.getElementById('cookie-accept').addEventListener('click', function () {
      localStorage.setItem(STORAGE_KEY, 'accepted');
      banner.classList.add('hidden');
      activateAnalytics();
    });

    document.getElementById('cookie-decline').addEventListener('click', function () {
      localStorage.setItem(STORAGE_KEY, 'declined');
      banner.classList.add('hidden');
    });

    function activateAnalytics() {
      document.querySelectorAll('script[data-category="analytics"]').forEach(function (el) {
        const newScript = document.createElement('script');
        // Copy attributes except type and data-category
        for (let i = 0; i < el.attributes.length; i++) {
          const attr = el.attributes[i];
          if (attr.name === 'type' || attr.name === 'data-category') continue;
          newScript.setAttribute(attr.name, attr.value);
        }
        // Copy inline content
        if (el.textContent) {
          newScript.textContent = el.textContent;
        }
        el.parentNode.replaceChild(newScript, el);
      });
    }
  })();
</script>
