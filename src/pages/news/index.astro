---
import PageLayout from '../../layouts/PageLayout.astro';
import AnnouncementCard from '../../components/astro/AnnouncementCard.astro';
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import { isPersonalMode } from '../../lib/config';

const personal = isPersonalMode();

const announcementsRaw = (await getCollection('announcements')).sort((a, b) => {
  if (a.data.pinned && !b.data.pinned) return -1;
  if (!a.data.pinned && b.data.pinned) return 1;
  return b.data.date.getTime() - a.data.date.getTime();
});

const announcements = await Promise.all(
  announcementsRaw.map(async (a) => {
    let imageUrl: string | undefined;
    if (a.data.image) {
      const resolved = await getImage({ src: a.data.image, width: 200 });
      imageUrl = resolved.src;
    }
    return { ...a, imageUrl };
  }),
);

const categories = [...new Set(announcements.map((a) => a.data.category))].sort();
---

<PageLayout
  title="News"
  description={personal
    ? 'Latest updates and announcements.'
    : 'Latest announcements, publications, grants, and awards.'}
>
  <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">News</h1>
  <p class="mb-6 text-sm text-surface-500 dark:text-dm-muted">
    {personal ? 'Latest updates and announcements.' : 'Latest announcements from our lab.'}
  </p>

  <!-- Category filters -->
  <div class="mb-6 flex flex-wrap items-center gap-1 text-sm">
    <span class="me-1 text-surface-400 dark:text-dm-faint">Filter:</span>
    <a
      href="/news"
      class="border-b-2 border-primary-600 px-2 py-1 font-medium text-primary-600 dark:border-accent-400 dark:text-accent-400"
    >
      All
    </a>
    {
      categories.map((cat) => (
        <a
          href={`/news/category/${cat}`}
          class="border-b-2 border-transparent px-2 py-1 text-surface-500 capitalize transition-colors hover:text-surface-700 dark:text-dm-muted dark:hover:text-[#c9d1d9]"
        >
          {cat}
        </a>
      ))
    }
  </div>

  <div class="divide-y divide-surface-100 dark:divide-dm-border">
    {
      announcements.map((a) => (
        <AnnouncementCard
          id={a.id}
          title={a.data.title}
          date={a.data.date}
          category={a.data.category}
          excerpt={a.data.excerpt}
          pinned={a.data.pinned}
          image={a.imageUrl}
          emoji={a.data.emoji}
        />
      ))
    }
  </div>
</PageLayout>
