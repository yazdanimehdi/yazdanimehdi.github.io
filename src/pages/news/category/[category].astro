---
import PageLayout from '../../../layouts/PageLayout.astro';
import AnnouncementCard from '../../../components/astro/AnnouncementCard.astro';
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';

export async function getStaticPaths() {
  const announcements = await getCollection('announcements');
  const categories = [...new Set(announcements.map((a) => a.data.category))];

  return categories.map((category) => ({
    params: { category },
    props: {
      category,
      announcements: announcements
        .filter((a) => a.data.category === category)
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { category, announcements: announcementsRaw } = Astro.props;

const announcements = await Promise.all(
  announcementsRaw.map(async (a: any) => {
    let imageUrl: string | undefined;
    if (a.data.image) {
      const resolved = await getImage({ src: a.data.image, width: 200 });
      imageUrl = resolved.src;
    }
    return { ...a, imageUrl };
  }),
);

const allAnnouncements = await getCollection('announcements');
const categories = [...new Set(allAnnouncements.map((a) => a.data.category))].sort();
---

<PageLayout title={`News: ${category}`} description={`News in the ${category} category.`}>
  <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 capitalize sm:text-3xl dark:text-dm-heading">
    {category} News
  </h1>
  <p class="mb-6 text-sm text-surface-500 dark:text-dm-muted">
    {announcements.length} announcement{announcements.length !== 1 ? 's' : ''} in this category.
  </p>

  <!-- Category filters -->
  <div class="mb-6 flex flex-wrap items-center gap-1 text-sm">
    <span class="me-1 text-surface-400 dark:text-dm-faint">Filter:</span>
    <a
      href="/news"
      class="border-b-2 border-transparent px-2 py-1 text-surface-500 transition-colors hover:text-surface-700 dark:text-dm-muted dark:hover:text-[#c9d1d9]"
    >
      All
    </a>
    {
      categories.map((cat) => (
        <a
          href={`/news/category/${cat}`}
          class:list={[
            'border-b-2 px-2 py-1 capitalize transition-colors',
            cat === category
              ? 'border-primary-600 font-medium text-primary-600 dark:border-accent-400 dark:text-accent-400'
              : 'border-transparent text-surface-500 hover:text-surface-700 dark:text-dm-muted dark:hover:text-[#c9d1d9]',
          ]}
        >
          {cat}
        </a>
      ))
    }
  </div>

  <div class="divide-y divide-surface-100 dark:divide-dm-border">
    {
      announcements.map((a) => (
        <AnnouncementCard
          id={a.id}
          title={a.data.title}
          date={a.data.date}
          category={a.data.category}
          excerpt={a.data.excerpt}
          pinned={a.data.pinned}
          image={a.imageUrl}
          emoji={a.data.emoji}
        />
      ))
    }
  </div>
</PageLayout>
