---
import PageLayout from '../../layouts/PageLayout.astro';
import Breadcrumb from '../../components/astro/Breadcrumb.astro';
import TagBadge from '../../components/astro/TagBadge.astro';
import ProseEnhancements from '../../components/astro/ProseEnhancements.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { getImage } from 'astro:assets';
import { getRoleName } from '../../lib/utils';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { id: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

let ogImage: string | undefined;
if (project.data.image) {
  const resolved = await getImage({ src: project.data.image, width: 1200 });
  ogImage = resolved.src;
}

// Resolve team members
const teamMembers = [];
if (project.data.team) {
  for (const personId of project.data.team) {
    const person = await getEntry('people', personId);
    if (person) teamMembers.push(person);
  }
}
---

<PageLayout title={project.data.title} description={project.data.excerpt} ogImage={ogImage}>
  <Breadcrumb />

  <div class="mt-4">
    <!-- Status & type badges -->
    <div class="mb-3 flex items-center gap-2 text-xs">
      <span
        class:list={[
          'rounded px-2 py-0.5 capitalize',
          project.data.status === 'active'
            ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400'
            : project.data.status === 'upcoming'
              ? 'bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-400'
              : 'bg-surface-100 text-surface-500 dark:bg-dm-alt dark:text-dm-muted',
        ]}
      >
        {project.data.status}
      </span>
      <span class="rounded bg-surface-100 px-2 py-0.5 text-surface-600 capitalize dark:bg-dm-alt dark:text-dm-muted">
        {project.data.type}
      </span>
    </div>

    <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">
      {project.data.title}
    </h1>

    {project.data.excerpt && <p class="mb-4 text-sm text-surface-500 dark:text-dm-muted">{project.data.excerpt}</p>}

    <!-- Links -->
    <div class="mb-6 flex flex-wrap items-center gap-3 text-sm">
      {
        project.data.url && (
          <a
            href={project.data.url}
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary-600 hover:underline dark:text-accent-400"
          >
            Website
          </a>
        )
      }
      {
        project.data.repoUrl && (
          <a
            href={project.data.repoUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary-600 hover:underline dark:text-accent-400"
          >
            Source Code
          </a>
        )
      }
      {
        project.data.paperUrl && (
          <a
            href={project.data.paperUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary-600 hover:underline dark:text-accent-400"
          >
            Paper
          </a>
        )
      }
    </div>

    {
      project.data.tags && project.data.tags.length > 0 && (
        <div class="mb-6 flex flex-wrap gap-2">
          {project.data.tags.map((tag) => (
            <TagBadge tag={tag} />
          ))}
        </div>
      )
    }

    <!-- Content -->
    <div class="prose mb-8">
      <Content />
    </div>
    <ProseEnhancements />

    <!-- Team -->
    {
      teamMembers.length > 0 && (
        <section class="border-t border-surface-200 pt-6 dark:border-dm-border">
          <h2 class="mb-3 font-serif text-lg font-normal text-surface-900 dark:text-dm-heading">Team</h2>
          <div class="flex flex-wrap gap-3">
            {teamMembers.map((member) => (
              <a
                href={`/people/${member.id}`}
                class="flex items-center gap-2 rounded border border-surface-200 px-3 py-2 text-sm transition-colors hover:border-primary-300 dark:border-dm-border dark:hover:border-accent-500"
              >
                <div class="flex h-7 w-7 items-center justify-center rounded-full bg-surface-100 text-xs font-medium text-surface-500 dark:bg-dm-alt dark:text-dm-muted">
                  {member.data.name
                    .split(' ')
                    .map((n) => n[0])
                    .join('')}
                </div>
                <div>
                  <span class="text-surface-900 dark:text-dm-heading">{member.data.name}</span>
                  <span class="ms-1 text-surface-400 dark:text-dm-faint">{getRoleName(member.data.role)}</span>
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }
  </div>
</PageLayout>
