---
import PageLayout from '../../layouts/PageLayout.astro';
import TagBadge from '../../components/astro/TagBadge.astro';
import { getCollection } from 'astro:content';
import { isPersonalMode } from '../../lib/config';

const personal = isPersonalMode();

const positions = (await getCollection('positions')).sort((a, b) => {
  // Open positions first, then closed
  const statusOrder = { open: 0, closed: 1 };
  const aStatus = statusOrder[a.data.status] ?? 2;
  const bStatus = statusOrder[b.data.status] ?? 2;
  if (aStatus !== bStatus) return aStatus - bStatus;
  // Within same status, sort by sortOrder
  return a.data.sortOrder - b.data.sortOrder;
});

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

function formatType(type: string): string {
  const labels: Record<string, string> = {
    phd: 'PhD',
    postdoc: 'Postdoc',
    masters: 'Masters',
    undergrad: 'Undergrad',
    'research-assistant': 'Research Assistant',
    visiting: 'Visiting',
    other: 'Other',
  };
  return labels[type] || type;
}
---

<PageLayout
  title={personal ? 'Prospective Students & Opportunities' : 'Open Positions'}
  description={personal
    ? 'Opportunities to work with me.'
    : 'Open positions and opportunities to join our research lab.'}
>
  <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">
    {personal ? 'Prospective Students & Opportunities' : 'Open Positions'}
  </h1>
  <p class="mb-6 text-sm text-surface-500 dark:text-dm-muted">
    {
      personal
        ? 'Current openings and opportunities to work with me.'
        : 'Current openings and opportunities to join our research lab.'
    }
  </p>

  <div class="space-y-3">
    {
      positions.map((p) => (
        <a
          href={`/positions/${p.id}`}
          class="group block border-b border-surface-100 py-4 last:border-b-0 dark:border-dm-border"
        >
          <div class="mb-1 flex items-start justify-between gap-3">
            <h3 class="font-medium text-surface-900 transition-colors group-hover:text-primary-600 dark:text-dm-heading dark:group-hover:text-accent-400">
              {p.data.title}
            </h3>
            <div class="flex shrink-0 gap-2">
              <span class="text-xs text-surface-400 dark:text-dm-faint">{formatType(p.data.type)}</span>
              <span
                class:list={[
                  'rounded px-2 py-0.5 text-xs',
                  p.data.status === 'open'
                    ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400'
                    : 'bg-surface-100 text-surface-400 dark:bg-dm-alt dark:text-dm-faint',
                ]}
              >
                {p.data.status === 'open' ? 'Open' : 'Closed'}
              </span>
            </div>
          </div>

          {p.data.excerpt && (
            <p class="mb-2 line-clamp-2 text-sm text-surface-500 dark:text-dm-muted">{p.data.excerpt}</p>
          )}

          <div class="flex flex-wrap items-center gap-3">
            {p.data.deadline && (
              <span class="text-xs text-surface-400 dark:text-dm-faint">Deadline: {formatDate(p.data.deadline)}</span>
            )}
            {p.data.tags && p.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-1.5">
                {p.data.tags.map((tag) => (
                  <TagBadge tag={tag} size="sm" />
                ))}
              </div>
            )}
          </div>
        </a>
      ))
    }
  </div>

  {
    positions.length === 0 && (
      <p class="py-8 text-center text-sm text-surface-400 dark:text-dm-faint">
        No positions are currently listed. Please check back later.
      </p>
    )
  }
</PageLayout>
