---
import PageLayout from '../../layouts/PageLayout.astro';
import Breadcrumb from '../../components/astro/Breadcrumb.astro';
import TagBadge from '../../components/astro/TagBadge.astro';
import ApplicationForm from '../../components/vue/ApplicationForm.vue';
import { getCollection, render } from 'astro:content';
import { getSiteConfig } from '../../lib/config';

export async function getStaticPaths() {
  const positions = await getCollection('positions');
  return positions.map((position) => ({
    params: { id: position.id },
    props: { position },
  }));
}

const { position } = Astro.props;
const { Content } = await render(position);
const config = getSiteConfig();

const contactEmail = position.data.contact || config.socials.email || '';
const web3formsKey = config.web3forms?.accessKey;

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

function formatType(type: string): string {
  const labels: Record<string, string> = {
    phd: 'PhD',
    postdoc: 'Postdoc',
    masters: 'Masters',
    undergrad: 'Undergrad',
    'research-assistant': 'Research Assistant',
    visiting: 'Visiting',
    other: 'Other',
  };
  return labels[type] || type;
}
---

<PageLayout title={position.data.title} description={position.data.excerpt}>
  <Breadcrumb />

  <div class="mt-4">
    <!-- Status & type badges -->
    <div class="mb-3 flex items-center gap-2 text-xs">
      <span
        class:list={[
          'rounded px-2 py-0.5',
          position.data.status === 'open'
            ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400'
            : 'bg-surface-100 text-surface-500 dark:bg-dm-alt dark:text-dm-muted',
        ]}
      >
        {position.data.status === 'open' ? 'Open' : 'Closed'}
      </span>
      <span class="rounded bg-surface-100 px-2 py-0.5 text-surface-600 dark:bg-dm-alt dark:text-dm-muted">
        {formatType(position.data.type)}
      </span>
    </div>

    <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">
      {position.data.title}
    </h1>

    {position.data.excerpt && <p class="mb-4 text-sm text-surface-500 dark:text-dm-muted">{position.data.excerpt}</p>}

    <!-- Deadline -->
    {
      position.data.deadline && (
        <p class="mb-4 text-sm text-surface-500 dark:text-dm-muted">
          <span class="font-medium text-surface-700 dark:text-dm-text">Application Deadline:</span>{' '}
          {formatDate(position.data.deadline)}
        </p>
      )
    }

    <!-- Tags -->
    {
      position.data.tags && position.data.tags.length > 0 && (
        <div class="mb-6 flex flex-wrap gap-2">
          {position.data.tags.map((tag) => (
            <TagBadge tag={tag} />
          ))}
        </div>
      )
    }

    <!-- Content -->
    <div class="prose mb-8">
      <Content />
    </div>

    <!-- Application Form (only for open positions) -->
    {
      position.data.status === 'open' && (
        <section class="border-t border-surface-200 pt-6 dark:border-dm-border">
          <h2 class="mb-4 font-serif text-lg font-normal text-surface-900 dark:text-dm-heading">
            Apply for This Position
          </h2>
          {web3formsKey ? (
            <ApplicationForm
              client:visible
              positionTitle={position.data.title}
              contactEmail={contactEmail}
              accessKey={web3formsKey}
            />
          ) : (
            <p class="text-sm text-surface-500 dark:text-dm-muted">
              To apply for this position, please email{' '}
              <a href={`mailto:${contactEmail}`} class="text-primary-600 hover:underline dark:text-accent-400">
                {contactEmail}
              </a>{' '}
              with your CV and research interests.
            </p>
          )}
        </section>
      )
    }

    <!-- Closed position notice -->
    {
      position.data.status === 'closed' && (
        <section class="border-t border-surface-200 pt-6 dark:border-dm-border">
          <p class="text-sm text-surface-500 dark:text-dm-muted">
            This position is currently closed. For general inquiries, please contact{' '}
            <a href={`mailto:${contactEmail}`} class="text-primary-600 hover:underline dark:text-accent-400">
              {contactEmail}
            </a>
            .
          </p>
        </section>
      )
    }
  </div>
</PageLayout>
