---
import PageLayout from '../../layouts/PageLayout.astro';
import PostCard from '../../components/astro/PostCard.astro';
import FeedItem from '../../components/astro/FeedItem.astro';
import { getCollection } from 'astro:content';
import { isPersonalMode } from '../../lib/config';

const personal = isPersonalMode();

const posts = (await getCollection('posts'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const feeds = (await getCollection('feeds')).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Combine into a unified timeline
type TimelineItem = {
  type: 'post' | 'feed';
  date: Date;
  data: (typeof posts)[0] | (typeof feeds)[0];
};

const timeline: TimelineItem[] = [
  ...posts.map((p) => ({ type: 'post' as const, date: p.data.date, data: p })),
  ...feeds.map((f) => ({ type: 'feed' as const, date: new Date(f.data.date), data: f })),
].sort((a, b) => b.date.getTime() - a.date.getTime());
---

<PageLayout
  title="Blog"
  description={personal
    ? 'Posts, articles, and technical writing.'
    : 'Lab blog posts and external articles from our team.'}
>
  <h1 class="mb-2 font-serif text-2xl font-normal text-surface-900 sm:text-3xl dark:text-dm-heading">Blog</h1>
  <p class="mb-6 text-sm text-surface-500 dark:text-dm-muted">
    {
      personal
        ? 'Posts, articles, and technical writing.'
        : 'Posts from our team, including lab blog entries and external articles.'
    }
  </p>

  <!-- All tags -->
  {
    (() => {
      const allTags = [...new Set(posts.flatMap((p) => p.data.tags || []))].sort();
      return allTags.length > 0 ? (
        <div class="mb-6 flex flex-wrap items-center gap-2 text-xs">
          <span class="text-surface-400 dark:text-dm-faint">Tags:</span>
          {allTags.map((tag) => (
            <a
              href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
              class="text-surface-500 transition-colors hover:text-primary-600 dark:text-dm-muted dark:hover:text-accent-400"
            >
              #{tag.toLowerCase().replace(/\s+/g, '-')}
            </a>
          ))}
        </div>
      ) : null;
    })()
  }

  <div class="divide-y divide-surface-100 dark:divide-dm-border">
    {
      timeline.map((item) => {
        if (item.type === 'post') {
          const post = item.data as (typeof posts)[0];
          return (
            <PostCard
              id={post.id}
              title={post.data.title}
              date={post.data.date}
              excerpt={post.data.excerpt}
              tags={post.data.tags}
              author={post.data.author}
            />
          );
        } else {
          const feed = item.data as (typeof feeds)[0];
          return (
            <FeedItem
              title={feed.data.title}
              link={feed.data.link}
              date={feed.data.date}
              source={feed.data.source}
              excerpt={feed.data.excerpt}
              author={feed.data.author}
            />
          );
        }
      })
    }
  </div>
</PageLayout>
