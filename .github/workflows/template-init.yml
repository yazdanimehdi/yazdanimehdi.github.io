name: Initialize Template

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pages: write

jobs:
  init:
    runs-on: ubuntu-latest
    # Only run on repos generated from this template, not on the template itself
    if: ${{ !github.event.repository.is_template }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if template needs initialization
        id: check
        run: |
          # If cms.yml still has the default placeholder, this is an uninitialized template
          if grep -q "repo:.*your-username/your-repo" config/cms.yml; then
            echo "needs_init=true" >> "$GITHUB_OUTPUT"
          else
            echo "needs_init=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure template
        if: steps.check.outputs.needs_init == 'true'
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Update adminUsers in site.yml
          sed -i "s/- ['\"]janesmith['\"]/- '${OWNER}'/" config/site.yml

          # Update repo in cms.yml
          sed -i "s|repo: ['\"]your-username/your-repo['\"]|repo: '${REPO}'|" config/cms.yml

          # Record template source and baseline SHA for sync workflow
          TEMPLATE_REPO=$(gh api "repos/${REPO}" --jq '.template_repository.full_name // empty')
          if [ -n "$TEMPLATE_REPO" ]; then
            echo "$TEMPLATE_REPO" > .github/.template-source
            TEMPLATE_SHA=$(git ls-remote "https://github.com/${TEMPLATE_REPO}.git" HEAD | cut -f1)
            echo "$TEMPLATE_SHA" > .github/.template-sync-sha
          fi

      - name: Commit changes
        if: steps.check.outputs.needs_init == 'true'
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add config/site.yml config/cms.yml
          [ -f .github/.template-source ] && git add .github/.template-source .github/.template-sync-sha
          git diff --cached --quiet || git commit -m "chore: initialize template for ${OWNER}"
          git pull --rebase
          git push

      - name: Enable GitHub Pages (Actions source)
        if: steps.check.outputs.needs_init == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # Enable Pages with Actions build source (prevents default Jekyll build)
          if ! gh api "repos/${REPO}/pages" \
            --method POST \
            --field build_type=workflow \
            --silent 2>/dev/null; then
            # Already exists -- update to Actions source
            gh api "repos/${REPO}/pages" \
              --method PUT \
              --field build_type=workflow \
              --silent 2>/dev/null || true
          fi

      - name: Determine site URL
        if: steps.check.outputs.needs_init == 'true'
        id: url
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # username.github.io repos are served at the root
          if [ "${REPO_NAME}" = "${OWNER}.github.io" ]; then
            echo "site_url=https://${OWNER}.github.io" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://${OWNER}.github.io/admin/" >> "$GITHUB_OUTPUT"
          else
            echo "site_url=https://${OWNER}.github.io/${REPO_NAME}" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://${OWNER}.github.io/${REPO_NAME}/admin/" >> "$GITHUB_OUTPUT"
          fi

      - name: Create setup issue
        if: steps.check.outputs.needs_init == 'true'
        uses: actions/github-script@v7
        env:
          SITE_URL: ${{ steps.url.outputs.site_url }}
          ADMIN_URL: ${{ steps.url.outputs.admin_url }}
        with:
          script: |
            const siteUrl = process.env.SITE_URL;
            const adminUrl = process.env.ADMIN_URL;
            const owner = context.repo.owner;

            // Ensure the label exists before using it
            try {
              await github.rest.issues.getLabel({ ...context.repo, name: 'setup' });
            } catch {
              await github.rest.issues.createLabel({ ...context.repo, name: 'setup', color: '0075ca' });
            }

            await github.rest.issues.create({
              ...context.repo,
              title: 'Setup: Enable CMS & GitHub Pages',
              labels: ['setup'],
              body: `## 1. Enable GitHub Pages

            Set GitHub Pages to deploy via **GitHub Actions** (not Jekyll):

            > **[Settings > Pages](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/pages)** > Build and deployment > Source > **GitHub Actions**

            ## 2. Access the CMS

            Your site uses [Sveltia CMS](https://github.com/sveltia/sveltia-cms). Go to **[${adminUrl}](${adminUrl})** after your first deploy completes.

            ### Option A: Sign in with a Personal Access Token (simplest)

            1. Create a [GitHub Personal Access Token](https://github.com/settings/tokens/new) with \`repo\` scope
            2. On the CMS login screen, click **"Sign in with GitHub"**, then use the token option
            3. Paste your token — you're in!

            ### Option B: OAuth via Cloudflare Worker (for team use)

            For a proper "Login with GitHub" button (recommended for multiple editors):

            1. **Deploy the auth worker** — run \`cd cloudflare-auth && npm install && npx wrangler deploy\` (requires a free [Cloudflare account](https://dash.cloudflare.com/sign-up))
            2. **Create a GitHub OAuth App** at [Developer Settings > OAuth Apps](https://github.com/settings/applications/new):
               - **Application name:** \`${owner} site CMS\`
               - **Homepage URL:** \`${siteUrl}\`
               - **Authorization callback URL:** \`https://sveltia-cms-auth.YOUR_SUBDOMAIN.workers.dev/callback\`
            3. **Set Worker environment variables** in the Cloudflare dashboard:
               - \`GITHUB_CLIENT_ID\` — your OAuth App Client ID
               - \`GITHUB_CLIENT_SECRET\` — your OAuth App Client Secret (encrypt it)
               - \`ALLOWED_DOMAINS\` — \`${context.repo.owner}.github.io\`
            4. **Update \`config/cms.yml\`** — uncomment and set \`base_url\`:
               \`\`\`yaml
               backend:
                 name: github
                 repo: "${context.repo.owner}/${context.repo.repo}"
                 branch: main
                 base_url: "https://sveltia-cms-auth.YOUR_SUBDOMAIN.workers.dev"
               \`\`\`
            5. Commit and push — after rebuild, the login button will use your OAuth worker

            ---
            *This issue was created automatically by the template initialization workflow. Close it once setup is complete.*`
            });
